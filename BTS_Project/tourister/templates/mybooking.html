{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KSRTC BTC - My Bookings</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        .card-fade-out { opacity: 0; transform: scale(0.95); transition: all 0.4s ease; }
        /* ஸ்டார் ஆக்டிவ் ஆக இருக்கும்போது அதன் நிறம் */
        .star-active { color: #fbbf24 !important; } 
    </style>
</head>
<body class="bg-gray-50 font-sans">
    {% include 'components/navbar.html' %}

    <section class="py-10 px-6 text-center bg-white border-b border-gray-100">
        <h2 class="text-3xl font-black text-slate-800 tracking-tight uppercase italic">My <span class="text-rose-600">Bookings</span></h2>
    </section>

    <div class="container mx-auto px-4 md:px-12 py-8">
        <div id="bookingList" class="space-y-6">
            <div id="loading" class="text-center py-20">
                <i class="fas fa-circle-notch fa-spin text-3xl text-rose-600"></i>
                <p class="mt-4 text-slate-500 font-bold uppercase tracking-widest text-xs">Fetching journeys...</p>
            </div>
        </div>
    </div>

    <div id="reviewPopup" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 w-11/12 md:w-1/3 relative shadow-2xl rounded-3xl border border-rose-100">
            <button onclick="closeReviewPopup()" class="absolute top-5 right-5 text-slate-400 hover:text-rose-600 transition-colors"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-black text-slate-800 mb-4 uppercase italic">Write <span class="text-rose-600">Review</span></h3>
            <p id="packageNameDisplay" class="text-slate-500 font-bold text-sm mb-6 border-b pb-2 italic"></p>
            
            <div class="flex mb-6 justify-center" id="starContainer">
                <i class="fa-solid fa-star text-slate-200 text-3xl cursor-pointer mx-1 transition-all hover:scale-110" data-value="1"></i>
                <i class="fa-solid fa-star text-slate-200 text-3xl cursor-pointer mx-1 transition-all hover:scale-110" data-value="2"></i>
                <i class="fa-solid fa-star text-slate-200 text-3xl cursor-pointer mx-1 transition-all hover:scale-110" data-value="3"></i>
                <i class="fa-solid fa-star text-slate-200 text-3xl cursor-pointer mx-1 transition-all hover:scale-110" data-value="4"></i>
                <i class="fa-solid fa-star text-slate-200 text-3xl cursor-pointer mx-1 transition-all hover:scale-110" data-value="5"></i>
            </div>
            
            <textarea id="reviewText" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 mb-6 focus:ring-2 focus:ring-rose-500 outline-none text-sm font-medium" rows="4" placeholder="How was your journey?"></textarea>
            
            <button id="submitBtn" onclick="submitReview()" class="w-full py-4 bg-rose-600 text-white rounded-2xl font-black uppercase tracking-widest text-xs hover:bg-rose-700 transition-all shadow-lg active:scale-95">
                Post Review
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const bookingList = document.getElementById("bookingList");
        const apiUrl = "/tourister/mybooking/"; 
        const reviewUrl = "/tourister/ratereview/"; // உங்கள் RateReview API URL

        let selectedRating = 0;

        // 1. Fetch Bookings
        async function fetchBookings() {
            const token = localStorage.getItem("access");
            if (!token) { window.location.href = "{% url 'tourister:login' %}"; return; }

            try {
                const response = await axios.get(apiUrl, {
                    headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
                });

                const bookings = response.data;
                bookingList.innerHTML = "";

                if (bookings.length === 0) {
                    bookingList.innerHTML = `<div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-200 text-slate-400 font-bold">No bookings found</div>`;
                    return;
                }

                bookings.forEach(booking => {
                    const pkg = booking.package || {};
                    const bus = pkg.bus || {};
                    const pkgName = pkg.package_name || "N/A";
                    const bookingDate = new Date(booking.booking_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    
                    const card = document.createElement("div");
                    card.id = `booking-card-${booking.id}`;
                    card.className = "w-full bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden flex flex-col md:flex-row hover:shadow-md transition-all";
                    
                    card.innerHTML = `
                        <div class="md:w-2 bg-rose-600"></div>
                        <div class="flex-1 p-6 md:p-8 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex-1 text-center md:text-left">
                                <div class="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-1">Package Details</div>
                                <h3 class="text-2xl font-black text-slate-800">${pkgName}</h3>
                                <div class="flex flex-wrap justify-center md:justify-start gap-4 text-xs font-bold text-slate-400 italic">
                                    <span><i class="far fa-calendar-alt mr-1"></i> ${pkg.start_date} to ${pkg.end_date}</span>
                                    <span><i class="fas fa-map-marker-alt mr-1"></i> ${booking.boarding_point}</span>
                                </div>
                            </div>

                            <div class="flex-1 flex justify-around w-full border-y md:border-y-0 md:border-x border-slate-50 py-4">
                                <div class="text-center">
                                    <p class="text-[9px] font-black text-slate-400 uppercase">Bus Info</p>
                                    <p class="text-xs font-black text-slate-700">${bus.bus_name}</p>
                                    <p class="text-[10px] font-bold text-rose-500">${bus.bus_number}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[9px] font-black text-slate-400 uppercase">Travelers</p>
                                    <p class="text-xs font-black text-slate-700">${booking.adults} Adults</p>
                                    <p class="text-[10px] font-bold text-slate-500">${booking.children} Kids</p>
                                </div>
                            </div>

                            <div class="text-center md:text-right min-w-[150px]">
                                <p class="text-[9px] font-black text-slate-400 uppercase">Total Fare</p>
                                <p class="text-2xl font-black text-rose-600">₹${booking.total_price}</p>
                                <p class="text-[9px] font-bold text-slate-400 mb-4">Booked on ${bookingDate}</p>
                                <div class="flex gap-2">
                                    <button onclick="openReviewPopup('${pkgName}')" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase hover:bg-slate-700 transition">Review</button>
                                    <button onclick="cancelBooking(${booking.id})" class="px-4 py-2 border-2 border-rose-50 text-rose-600 rounded-xl text-[10px] font-black uppercase hover:bg-rose-100 transition">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;
                    bookingList.appendChild(card);
                });
            } catch (error) {
                bookingList.innerHTML = `<p class="text-center text-rose-500 py-10 font-bold">Error loading data.</p>`;
            }
        }

        // 2. Star Rating Logic
        document.querySelectorAll('#starContainer i').forEach(star => {
            star.onclick = () => {
                selectedRating = star.dataset.value;
                document.querySelectorAll('#starContainer i').forEach(s => {
                    s.classList.toggle('star-active', s.dataset.value <= selectedRating);
                    s.classList.toggle('text-slate-200', s.dataset.value > selectedRating);
                });
            };
        });

        // 3. Review Submission (Axios Post)
        async function submitReview() {
            const reviewText = document.getElementById("reviewText").value;
            const token = localStorage.getItem("access");
            const btn = document.getElementById("submitBtn");

            if (selectedRating === 0) {
                alert("Please select a star rating!");
                return;
            }

            if (!reviewText.trim()) {
                alert("Please write a short review!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Posting...";

            try {
                const response = await axios.post(reviewUrl, {
                    rating: parseInt(selectedRating),
                    review: reviewText
                }, {
                    headers: { 
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (response.status === 201 || response.status === 200) {
                    alert("Thank you! Review submitted successfully.");
                    closeReviewPopup();
                }
            } catch (error) {
                console.error(error);
                alert(error.response?.data?.detail || "Failed to post review. Please try again.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Post Review";
            }
        }

        // 4. Helper Functions
        function openReviewPopup(name) {
            document.getElementById('packageNameDisplay').innerText = name;
            document.getElementById('reviewPopup').classList.replace('hidden', 'flex');
        }

        function closeReviewPopup() {
            document.getElementById('reviewPopup').classList.replace('flex', 'hidden');
            // Reset fields
            selectedRating = 0;
            document.getElementById("reviewText").value = "";
            document.querySelectorAll('#starContainer i').forEach(s => {
                s.classList.remove('star-active');
                s.classList.add('text-slate-200');
            });
        }

        async function cancelBooking(id) {
            if (!confirm("Are you sure? Seats will be released back.")) return;
            const token = localStorage.getItem("access");
            try {
                await axios.delete(`${apiUrl}${id}/`, { headers: { "Authorization": `Bearer ${token}` } });
                document.getElementById(`booking-card-${id}`).classList.add('card-fade-out');
                setTimeout(() => fetchBookings(), 400);
            } catch (error) { alert("Cancellation failed."); }
        }

        fetchBookings();
    </script>
</body>
</html>