<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Stay | KSRTC Tourism</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { overflow-x: hidden; }
        @media (min-height: 850px) { body { overflow-y: hidden; } }
        .custom-input:focus {
            box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
            border-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans flex flex-col">
    {% include 'components/navbar.html' %}

    <div class="flex-grow flex items-center justify-center p-4">
        <div class="max-w-2xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            
            <div class="bg-red-600 p-5 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-black uppercase italic tracking-tighter leading-none">Complete <span class="text-red-200">Booking</span></h2>
                        <p class="text-red-100 text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">KSRTC Tourism Partner Hotels</p>
                    </div>
                    <i class="fas fa-hotel text-3xl text-red-400/50"></i>
                </div>
            </div>

            <div class="px-8 py-3 bg-red-50/50 border-b border-red-100 flex justify-between items-center">
                <div class="flex-1">
                    <h3 id="hotelName" class="text-xl font-black text-gray-900 leading-none">Loading...</h3>
                    <p id="roomInfo" class="text-gray-500 font-bold text-[9px] mt-1 italic uppercase tracking-wider">Fetching details...</p>
                </div>
                <div class="text-right">
                    <p class="text-[8px] font-black text-red-600 uppercase leading-none">Rate per Room / Night</p>
                    <p id="basePrice" class="text-lg font-black text-gray-900">₹0</p>
                </div>
            </div>

            <form id="bookingForm" class="p-6 space-y-4">
                {% csrf_token %}
                
                <div>
                    <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Guest Full Name</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i>
                        <input type="text" id="guest_name" required placeholder="Enter name as per Govt ID" 
                            class="w-full bg-gray-50 border-none rounded-xl pl-11 pr-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Check-In</label>
                        <input type="date" id="check_in_date" required 
                            class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Check-Out</label>
                        <input type="date" id="check_out_date" required 
                            class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Adults</label>
                        <input type="number" id="adults" min="1" value="1" 
                            class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Children</label>
                        <input type="number" id="children" min="0" value="0" 
                            class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black uppercase text-gray-400 tracking-widest mb-1 ml-1">Mobile No</label>
                        <input type="tel" id="phone_number" required placeholder="10 Digits" 
                            class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-xs font-bold outline-none transition-all custom-input">
                    </div>
                </div>

                <div class="mt-6 bg-gray-900 rounded-2xl p-5 flex justify-between items-center shadow-xl">
                    <div class="flex flex-col">
                        <span id="calcBreakdown" class="text-[8px] font-bold text-red-400 uppercase tracking-tighter mb-1">Room Price × 1 Night</span>
                        <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest leading-none">Total Payable</p>
                        <h2 class="text-3xl font-black text-white italic tracking-tighter leading-none mt-1">₹<span id="total_price_display">0</span></h2>
                    </div>
                    <button type="submit" id="submitBtn" class="bg-red-600 hover:bg-red-500 text-white px-8 py-4 rounded-xl font-black uppercase tracking-widest text-[10px] transition-all active:scale-95 shadow-lg shadow-red-900/30">
                        Confirm & Pay
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const roomId = "{{ room_id }}";
        let roomRate = 0; 

        async function loadRoomDetails() {
            try {
                const response = await axios.get(window.location.pathname, {
                    headers: { 'Accept': 'application/json' }
                });
                
                const data = response.data;
                document.getElementById('hotelName').innerText = data.hotel_name;
                document.getElementById('roomInfo').innerText = `${data.room_type || 'Standard'} — Room ${data.room_number || ''}`;
                document.getElementById('basePrice').innerText = `₹${data.price}`;
                
                roomRate = parseFloat(data.price);
                calculateTotal();
            } catch (error) {
                console.error("Room Load Error:", error);
                document.getElementById('hotelName').innerText = "Error loading details";
            }
        }

        function calculateTotal() {
            const checkInVal = document.getElementById('check_in_date').value;
            const checkOutVal = document.getElementById('check_out_date').value;
            
            let nights = 1;
            if (checkInVal && checkOutVal) {
                const start = new Date(checkInVal);
                const end = new Date(checkOutVal);
                if (end > start) {
                    nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                }
            }

            const grandTotal = roomRate * nights;
            
            document.getElementById('total_price_display').innerText = grandTotal.toLocaleString('en-IN');
            document.getElementById('calcBreakdown').innerText = `Rate: ₹${roomRate} × ${nights} Night(s)`;
            
            return grandTotal;
        }

        ['check_in_date', 'check_out_date'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateTotal);
        });

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';

            const payload = {
                guest_name: document.getElementById('guest_name').value,
                check_in_date: document.getElementById('check_in_date').value,
                check_out_date: document.getElementById('check_out_date').value,
                phone_number: document.getElementById('phone_number').value,
                adults: parseInt(document.getElementById('adults').value),
                children: parseInt(document.getElementById('children').value),
                total_price: calculateTotal()
            };

            const token = localStorage.getItem('access_token');
            const headers = { 
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                
                await axios.post(window.location.pathname, payload, { 
                    headers: headers,
                    withCredentials: true 
                });
                
                alert("Booking Confirmed Successfully!");
                window.location.href = "/tourister/hotelmybooking/"; 
            } catch (error) {
                console.error("Booking Error:", error.response);
                if (error.response && (error.response.status === 401 || error.response.status === 403)) {
                    alert("Your session expired. Please login again.");
                    window.location.href = "/tourister/login/";
                } else {
                    alert("Error: " + (error.response?.data?.error || "Booking failed"));
                }
                btn.disabled = false;
                btn.innerText = "Confirm & Pay";
            }
        });

        loadRoomDetails();
    </script>
</body>
</html>