<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Update Travel Package</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-purple-50 min-h-screen font-sans text-gray-800">

    {% include "navbar.html" %}

    <div class="container mx-auto py-8 px-4">
        <div class="flex items-center justify-between mb-8 mt-20">
            <h1 class="text-3xl font-black text-purple-900 uppercase">Edit Package</h1>
            <button onclick="window.location.href='/admin_site/packages/'" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-xl font-bold transition">
                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </button>
        </div>

        <form id="updateForm">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-8">
                        <h2 class="text-xl font-bold text-purple-900 mb-6 flex items-center">
                            <i class="fas fa-edit mr-3"></i> Package Information
                        </h2>
                        
                        <div id="backendErrors" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-600 mb-2">Package Name</label>
                                <input type="text" id="package_name" required class="w-full bg-purple-50 border border-purple-100 rounded-xl p-3 outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-600 mb-2">Overview</label>
                                <textarea id="package_overview" rows="4" required class="w-full bg-purple-50 border border-purple-100 rounded-xl p-3 outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-600 mb-2">Duration</label>
                                <input type="text" id="duration" required class="w-full bg-purple-50 border border-purple-100 rounded-xl p-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-600 mb-2">Price (â‚¹)</label>
                                <input type="number" id="price" required class="w-full bg-purple-50 border border-purple-100 rounded-xl p-3 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-8">
                        <h2 class="text-xl font-bold text-purple-900 mb-6 italic">Day-wise Itinerary</h2>
                        <div id="itineraryContainer" class="space-y-4">
                            <div class="text-center text-gray-400 py-4">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Loading itinerary...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-purple-100 p-6">
                        <h2 class="text-lg font-bold text-purple-900 mb-4">Gallery Previews</h2>
                        <div class="grid grid-cols-2 gap-2 mb-4" id="imagePreviewGrid"></div>
                        <div class="space-y-3">
                            <input type="file" id="image1" class="text-xs w-full file:bg-purple-100 file:border-0 file:rounded-lg file:px-2 file:py-1">
                            <input type="file" id="image2" class="text-xs w-full file:bg-purple-100 file:border-0 file:rounded-lg file:px-2 file:py-1">
                            <input type="file" id="image3" class="text-xs w-full file:bg-purple-100 file:border-0 file:rounded-lg file:px-2 file:py-1">
                            <input type="file" id="image4" class="text-xs w-full file:bg-purple-100 file:border-0 file:rounded-lg file:px-2 file:py-1">
                        </div>
                    </div>

                    <button type="submit" id="updateBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all text-lg">
                        SAVE ALL CHANGES
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        axios.defaults.withCredentials = true;
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const pathSegments = window.location.pathname.split('/').filter(s => s !== "");
        const packageId = pathSegments[pathSegments.length - 1];

        async function loadAllData() {
            try {
                // Manager request removed from Promise.all
                const [pkgRes, itinRes] = await Promise.all([
                    axios.get(`http://127.0.0.1:8000/admin_site/packages/${packageId}/`),
                    axios.get('http://127.0.0.1:8000/admin_site/itineraries/')
                ]);

                const pkg = pkgRes.data;
                document.getElementById('package_name').value = pkg.package_name;
                document.getElementById('package_overview').value = pkg.package_overview;
                document.getElementById('duration').value = pkg.duration;
                document.getElementById('price').value = pkg.price;

                const previewGrid = document.getElementById('imagePreviewGrid');
                previewGrid.innerHTML = "";
                ['image1', 'image2', 'image3', 'image4'].forEach(imgKey => {
                    if (pkg[imgKey]) {
                        previewGrid.innerHTML += `<div class="h-20 bg-gray-100 rounded-lg overflow-hidden border"><img src="${pkg[imgKey]}" class="w-full h-full object-cover"></div>`;
                    }
                });

                const filteredItin = itinRes.data.filter(i => i.package == packageId);
                const container = document.getElementById('itineraryContainer');
                container.innerHTML = "";
                filteredItin.forEach(day => {
                    container.innerHTML += `
                        <div class="itinerary-block bg-purple-50 p-5 rounded-xl border border-purple-100 mb-4 animate-fade-in">
                            <div class="flex justify-between items-center mb-3">
                                <span class="bg-purple-700 text-white px-3 py-1 rounded-full text-xs font-bold">DAY ${day.day_number}</span>
                                <input type="hidden" class="day-id" value="${day.id}">
                            </div>
                            <input type="text" value="${day.title}" class="day-title w-full p-2 mb-2 rounded border outline-none">
                            <textarea class="day-desc w-full p-2 rounded border outline-none" rows="2">${day.description}</textarea>
                        </div>`;
                });
            } catch (err) {
                console.error(err);
                alert("Critical error loading data.");
            }
        }

        document.getElementById('updateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('updateBtn');
            const errorDiv = document.getElementById('backendErrors');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> UPDATING...';
            errorDiv.classList.add('hidden');

            const formData = new FormData();
            formData.append('package_name', document.getElementById('package_name').value);
            formData.append('package_overview', document.getElementById('package_overview').value);
            formData.append('duration', document.getElementById('duration').value);
            formData.append('price', document.getElementById('price').value);
            // managerSelect append removed

            ['image1', 'image2', 'image3', 'image4'].forEach(id => {
                const file = document.getElementById(id).files[0];
                if (file) formData.append(id, file);
            });

            try {
                await axios.put(`http://127.0.0.1:8000/admin_site/packages/${packageId}/`, formData, {
                    headers: { 
                        'Content-Type': 'multipart/form-data',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const dayBlocks = document.querySelectorAll('.itinerary-block');
                const dayPromises = Array.from(dayBlocks).map(block => {
                    const id = block.querySelector('.day-id').value;
                    return axios.put(`http://127.0.0.1:8000/admin_site/itineraries/${id}/`, {
                        package: packageId,
                        title: block.querySelector('.day-title').value,
                        description: block.querySelector('.day-desc').value,
                        day_number: block.querySelector('.bg-purple-700').innerText.replace('DAY ', '')
                    }, {
                        headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });
                });

                await Promise.all(dayPromises);
                alert("Success! Package updated.");
                window.location.href = '/admin_site/packages/';

            } catch (err) {
                errorDiv.classList.remove('hidden');
                if (err.response && err.response.data) {
                    let messages = [];
                    const data = err.response.data;
                    for (let key in data) { messages.push(`${key.toUpperCase()}: ${data[key]}`); }
                    errorDiv.innerHTML = `<strong>Fix the following:</strong><br>${messages.join('<br>')}`;
                } else {
                    errorDiv.innerText = "Connection lost or server error.";
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
                btn.disabled = false;
                btn.innerHTML = "SAVE ALL CHANGES";
            }
        });

        window.onload = loadAllData;
    </script>
</body>
</html>